<mat-toolbar role="banner" class="sticky-top z-index-high p-0" aria-label="Application header">
  <div class="w-100 px-2 d-flex align-items-center gap-3">
    <img src="images/isteer.png" height="50px" alt="iSteer logo">
    <strong class="h4 text-center dash-heading-text">Vulnerability Monitoring System</strong>
  </div>
</mat-toolbar>

<div class="container-fluid user-report-container">
  <!-- Top Box -->
  <div class="top-box bg-light border rounded-3 mb-3">
    <div class="bg-gray-shade p-2 rounded-top-3">
      <h2 class="text-center text-secondary">System Details</h2>
    </div>
    <div class="p-3">
      <div class="row">
        <div class="col-4 d-flex gap-2 align-items-center">
          <span class="label">Machine Name:</span>
          <span class="value" matTooltip="{{machineName}}">{{machineName}}</span>
        </div>
        <div class="col-4 d-flex gap-2 align-items-center">
          <span class="label">MAC Address:</span>
          <span class="value" matTooltip="{{macAddress}}">{{macAddress}}</span>
        </div>
        <div class="col-4 d-flex gap-2 align-items-center">
          <span class="label">IP Address:</span>
          <span class="value" matTooltip="{{ipAddress}}">{{ipAddress}}</span>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-4 d-flex gap-2 align-items-center">
          <span class="label">Serial Number:</span>
          <span class="value" matTooltip="{{serialNumber}}">{{serialNumber}}</span>
        </div>
        <div class="col-4 d-flex gap-2 align-items-center">
          <span class="label">Email:</span>
          <span class="value" matTooltip="{{loggedInUserEmail}}">{{loggedInUserEmail}}</span>
        </div>
        <div class="col-4 d-flex gap-2 align-items-center">
          <span class="label">Logged-in User:</span>
          <span class="value" matTooltip="{{loggedInUserName}}">{{loggedInUserName}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Section -->
  <!-- <div class="chart-section bg-light border rounded-3 mb-3">
    <div class="p-2 bg-gray-shade rounded-top-3">
      <h2 class="text-center text-secondary">Applications Overview</h2>
    </div>
    <div class="p-3 d-flex justify-content-evenly align-items-center gap-3">
      <div class="chart-card d-flex justify-content-center align-items-center">
        <canvas #appChart></canvas>
      </div>
      <div class="chart-card d-flex justify-content-center align-items-center">
        <canvas #severityChart></canvas>
      </div>
    </div>
  </div> -->
  <div class="d-flex justify-content-evenly align-items-center gap-3">
  <!-- Application Chart Card -->
  <div class="chart-card flex-column">
    <h5 class="chart-title text-secondary">Applications Distribution</h5>
    <canvas #appChart></canvas>
  </div>

  <!-- Severity Chart Card -->
  <div class="chart-card flex-column">
    <h5 class="chart-title text-secondary">Severity Distribution</h5>
    <canvas #severityChart></canvas>
  </div>
</div>


  <!-- Table and Severity Chart Section -->
  <div class="p-3 table-chart-section d-flex gap-3">
    <!-- Table -->
    <div class="table-section bg-light border rounded-3">
      <div class="p-2 bg-gray-shade rounded-top-3 d-flex justify-content-between align-items-center">
        <h2 class="text-secondary m-2">Applications</h2>
        <div class="d-flex align-items-center gap-2">
          <mat-slide-toggle [checked]="showVulnerableOnly" (change)="toggleVulnerableOnly()" color="warn" matTooltip="Toggle to show only vulnerable applications"></mat-slide-toggle>
          <input class="comp-search-field rounded ps-3 py-1 border border-1" type="text" placeholder="Search" [(ngModel)]="searchValue" (keyup)="searchApplications($event)">
        </div>
      </div>
      <div class="table-container">
        <table mat-table [dataSource]="pagedAppData" class="w-100">
          <!-- Software Name -->
          <ng-container matColumnDef="softwareName">
            <th class="text-secondary fw-bolder bg-gray-shade" mat-header-cell *matHeaderCellDef>Software Name</th>
            <td mat-cell *matCellDef="let app" class="col-4" style="cursor: pointer;">
              <div class="d-flex align-items-center gap-1">
                <i class="bi bi-circle-fill" style="color: #3DDC84; font-size: 5px;" *ngIf="app.runningProcessIds?.length > 0" matTooltip="Running Process IDs: {{app.runningProcessIds.join(', ')}}"></i>
                <span>{{app.softwareName}}</span>
                <span *ngIf="!app.resolved" class="material-symbols-outlined text-warning" matTooltip="Unresolved application">shield_question</span>
                <span *ngIf="app.criticalVulnerabilityCount + app.highVulnerabilityCount + app.mediumVulnerabilityCount + app.lowVulnerabilityCount > 0" class="text-danger cursor-pointer" [matTooltip]="'Contains vulnerabilities Tap to View'">
                  ({{app.criticalVulnerabilityCount + app.highVulnerabilityCount + app.mediumVulnerabilityCount + app.lowVulnerabilityCount}})
                  <i class="fa-solid fa-triangle-exclamation text-danger"></i>
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Software Version -->
          <ng-container matColumnDef="softwareVersion">
            <th class="text-secondary fw-bolder text-center" mat-header-cell *matHeaderCellDef>Version</th>
            <td class="text-center" mat-cell *matCellDef="let app">{{app.softwareVersion}}</td>
          </ng-container>

          <!-- Vendor -->
          <ng-container matColumnDef="vendor">
            <th class="text-secondary fw-bolder text-center" mat-header-cell *matHeaderCellDef>Vendor</th>
            <td class="text-center" mat-cell *matCellDef="let app">{{app.vendor}}</td>
          </ng-container>

          <!-- Table Rows -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" style="background-color: rgb(236, 241, 241);"></tr>
        <tr mat-row 
    *matRowDef="let row; columns: displayedColumns"
    [ngClass]="{
      'vulnerable-row': row.criticalVulnerabilityCount + row.highVulnerabilityCount + row.mediumVulnerabilityCount + row.lowVulnerabilityCount > 0,
      'unresolved-row': !row.resolved,
      'normal-row': row.criticalVulnerabilityCount + row.highVulnerabilityCount + row.mediumVulnerabilityCount + row.lowVulnerabilityCount === 0 && row.resolved
    }"
    (click)="viewVulnerabilities(row)"
    style="cursor: pointer;">
</tr>

        </table>
        <div *ngIf="!pagedAppData.length" class="text-center p-2">No data found</div>
      </div>

      <!-- Pagination -->
      
      <div *ngIf="pagedAppData.length > 0" class="p-2 d-flex justify-content-end pagination">
        <div class="d-flex gap-2 align-items-center">
          <mat-select class="border rounded page-size-width p-2" [(ngModel)]="recordIndex" (ngModelChange)="getPage($event)">
            <mat-option *ngFor="let record of totalRecords" [value]="record">{{record}}</mat-option>
          </mat-select>
          <mat-select class="border rounded page-size-width p-2" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)">
            <mat-option *ngFor="let size of pageSizes" [value]="size">{{size}}</mat-option>
          </mat-select>
          <button (click)="previousPage()" [disabled]="pageIndex === 0" class="page-custom-btn btn p-2">
            <mat-icon class="material-symbols-outlined fs-5">arrow_back_ios</mat-icon>
          </button>
          <button (click)="nextPage()" [disabled]="pageIndex >= totalPages - 1" class="page-custom-btn btn p-2">
            <mat-icon class="material-symbols-outlined fs-5">arrow_forward_ios</mat-icon>
          </button>
        </div>
      </div>

    </div>

    <!-- Per-Application vulnerability table -->
    <!-- <div class="severity-section bg-light border rounded-3">
      <div class="p-2 bg-gray-shade rounded-top-3">
        <h2 class="text-center text-secondary">Selected Application Vulnerabilities Data</h2>
      </div>
      <div class="p-3">
        <div *ngIf="!selectedApp || (selectedApp.criticalVulnerabilityCount + selectedApp.highVulnerabilityCount + selectedApp.mediumVulnerabilityCount + selectedApp.lowVulnerabilityCount === 0)" class="no-vulnerabilities text-center">
          <h4>No vulnerabilities data found</h4>
        </div>
        <div *ngIf="selectedApp && (selectedApp.criticalVulnerabilityCount + selectedApp.highVulnerabilityCount + selectedApp.mediumVulnerabilityCount + selectedApp.lowVulnerabilityCount > 0)" class="chart-card-app d-flex justify-content-center align-items-center">
          <canvas #appSeverityChart></canvas>
        </div>
      </div>
    </div> -->
     <div class="severity-section bg-light border rounded-3">
      <!-- <div class="p-2 bg-gray-shade rounded-top-3">
        <h2 class="text-center text-secondary">Selected Application Vulnerabilities</h2>
      </div> -->
      <div class="p-3">
                <h2 class="text-center text-secondary py-2">Selected Application Vulnerabilities</h2>

        <div *ngIf="!selectedApp || !selectedApp.vulnerabilities || selectedApp.vulnerabilities.length === 0" class="no-vulnerabilities text-center">
          <h4>No vulnerabilities found</h4>
        </div>
        <div *ngIf="selectedApp && selectedApp.vulnerabilities && selectedApp.vulnerabilities.length > 0" class="chart-card-app">
          <div class="vuln-header">
            <h3 class="text-ellipsis" matTooltip="{{selectedApp.softwareName}}">Vulnerabilities for <span class="fw-bolder text-secondary">{{selectedApp.softwareName}}</span></h3>
          </div>
          <div class="vuln-table-container">
            <table mat-table [dataSource]="filteredVulnerabilities" class="comp-table table table-striped">
              <ng-container matColumnDef="cveId">
                <th mat-header-cell *matHeaderCellDef>CVE ID</th>
                <td mat-cell *matCellDef="let vuln">
                  <span class="cursor-pointer" (click)="showVulnerabilityMetrics(vuln.cveId)">{{vuln.cveId}}</span>
                </td>
              </ng-container>
              <!-- <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Description</th>
                <td mat-cell *matCellDef="let vuln">{{vuln.description}}</td>
              </ng-container> -->
              <!-- <ng-container matColumnDef="severity">
                <th class="text-center" mat-header-cell *matHeaderCellDef>Severity</th>
                <td class="text-center" mat-cell *matCellDef="let vuln">
                  <span class="cursor-pointer" (click)="showVulnerabilityMetrics(vuln.cveId)" [ngClass]="{
                    'severity-critical': vuln.severity.toLowerCase() === 'critical',
                    'severity-high': vuln.severity.toLowerCase() === 'high',
                    'severity-medium': vuln.severity.toLowerCase() === 'medium',
                    'severity-low': vuln.severity.toLowerCase() === 'low'
                  }">{{vuln.severity}}</span>
                </td>
              </ng-container> -->
              <ng-container matColumnDef="severity">
  <th class="text-center" mat-header-cell *matHeaderCellDef>
    <div class="d-flex justify-content-center align-items-center gap-1">
      <span>Severity</span>
      <i class="bi cursor-pointer"
         [ngClass]="{
           'bi-sort-down': severitySort === 'desc',
           'bi-sort-up': severitySort === 'asc',
           'bi-filter': severitySort === 'default',
           'active': severitySort !== 'default'

         }"
         (click)="toggleSeveritySort()"
         matTooltip="Toggle Severity Sort">
      </i>
    </div>
  </th>

  <td class="text-center" mat-cell *matCellDef="let vuln">
    <span class="cursor-pointer"
          (click)="showVulnerabilityMetrics(vuln.cveId)"
          [ngClass]="{
            'severity-critical': vuln.severity.toLowerCase() === 'critical',
            'severity-high': vuln.severity.toLowerCase() === 'high',
            'severity-medium': vuln.severity.toLowerCase() === 'medium',
            'severity-low': vuln.severity.toLowerCase() === 'low'
          }">
      {{vuln.severity}}
    </span>
  </td>
</ng-container>

              <!-- <ng-container matColumnDef="cvssScore">
                <th class="text-center" mat-header-cell *matHeaderCellDef>CVSS Score</th>
                <td class="text-center" mat-cell *matCellDef="let vuln">{{vuln.cvssScore}}</td>
              </ng-container> -->
              <tr mat-header-row *matHeaderRowDef="vulnDisplayedColumns; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: vulnDisplayedColumns;"></tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>