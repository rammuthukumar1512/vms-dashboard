import { AfterViewInit, Component, ElementRef, Inject, OnInit, QueryList, ViewChild, ViewChildren } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MatDialogModule, MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';
import { MatButtonModule } from '@angular/material/button';
import { MatTableModule } from '@angular/material/table';
import { MatTooltipModule } from '@angular/material/tooltip';
import { MatCardModule } from '@angular/material/card';
import { FormsModule } from '@angular/forms';
import { Vulnerability } from '../../models/computer.model';
import { MatDialog } from '@angular/material/dialog';
import { LikelyCpeDialogComponent } from '../../resolve-applications/likely-cpe-dialog.component';
import { HttpClient } from '@angular/common/http';
import { ApiEndPoints } from '../../../environments/api-endpoints';
import { Router } from '@angular/router'; // Added for navigation
import { ApplicationResolveService } from '../../core/services/application-resolve.service';
import { VulnerabilityService } from '../../core/services/vulnerabilityService';
import { AppRoutes } from '../../../environments/approutes';

@Component({
  selector: 'app-vulnerability-dialog',
  standalone: true,
  imports: [CommonModule, MatDialogModule, MatButtonModule, MatTableModule, MatCardModule, FormsModule,MatTooltipModule],
  templateUrl: './vulnerability-dialog.component.html',
  styleUrls: ['./vulnerability-dialog.component.css']
})
export class VulnerabilityDialogComponent implements OnInit,AfterViewInit {
  vulnDisplayedColumns: string[] = ['cveId', 'description', 'severity', 'cvssScore'];
  filteredVulnerabilities: Vulnerability[] = [];
  isResolved: boolean = false;
  lastResolvedApp: { softwareName: string, uuid: string, machineName: string, pageIndex?: string, recordIndex?: string } | null = null;
  selectedSeverity: string | null = null;
  previousUrl: string | null = null;
  selectedRowIndex: number | null = null;
  @ViewChildren('vulnerabilityTableRow', { read: ElementRef }) vulnerabilityTableRows!: QueryList<ElementRef>;
  @ViewChild('vulnerabilityTable', { read: ElementRef }) vulnerabilityTable!: ElementRef;
  constructor(
    public dialogRef: MatDialogRef<VulnerabilityDialogComponent>,
    @Inject(MAT_DIALOG_DATA) public data: {
      softwareName: string;
      vulnerabilities: Vulnerability[];
      severityCounts: { critical: number; high: number; medium: number; low: number };
      cpeName: string | null;
      resolved: boolean;
      uuid: string;
      softwareVersion: string;
      vendor: string;
    },
    private dialog: MatDialog,
    private http: HttpClient,
    private router: Router,// Added for navigation
    private applicationResolveService: ApplicationResolveService ,
     private vulnerabilityService: VulnerabilityService// Added service

  ) {
    this.filteredVulnerabilities = this.data.vulnerabilities;
    this.isResolved = this.data.resolved;
  }

  ngOnInit(): void {
    this.previousUrl = this.applicationResolveService.getPreviousUrl();
    const selectedSeverity = this.vulnerabilityService.getSelectedVulnerabilitySeverity();
    if (this.previousUrl?.match('vulnerability-metrics')) {
      this.filterVulnerabilities(selectedSeverity as 'Critical' | 'High' | 'Medium' | 'Low');
      this.selectedRowIndex = this.vulnerabilityService.getSelectedVulnerabilityIndex();
    }
  }

  ngAfterViewInit(): void {
    const selectedVulnerabilityIndex = this.vulnerabilityService.getSelectedVulnerabilityIndex();
    if (this.vulnerabilityTableRows && this.vulnerabilityTableRows.length > 0) {
      const selectedRow = this.vulnerabilityTableRows.toArray()[selectedVulnerabilityIndex]?.nativeElement;
      selectedRow?.scrollIntoView({ behaviour: 'smooth', block: 'center'});
    }
  }

  filterVulnerabilities(severity: 'Critical' | 'High' | 'Medium' | 'Low' | null): void {
    this.vulnerabilityService.setSelectedVulnerabilitySeverity(severity);
    this.selectedSeverity = severity;
    this.filteredVulnerabilities = !severity
      ? this.data.vulnerabilities
      : this.data.vulnerabilities.filter(vuln => vuln.severity.toLowerCase() === severity.toLowerCase());
      // Apply blink effect
  if (this.vulnerabilityTable) {
    this.vulnerabilityTable.nativeElement.classList.add('table-blink');
    this.vulnerabilityTable.nativeElement.setAttribute('aria-live', 'polite');
    this.vulnerabilityTable.nativeElement.setAttribute('aria-label', `Filtered by ${severity || 'All'} severity`);
    setTimeout(() => {
      this.vulnerabilityTable.nativeElement.classList.remove('table-blink');
    }, 300); // Match animation duration
  }
  }

  openLikelyCpeModal(): void {
    const dialogRef = this.dialog.open(LikelyCpeDialogComponent, {
      width: '600px',
      data: {
        uuid: this.data.uuid,
        softwareName: this.data.softwareName,
        softwareVersion: this.data.softwareVersion,
        vendor: this.data.vendor
      }
    });

    dialogRef.afterClosed().subscribe((result: any) => {
      if (result && !this.isResolved) {
        this.lastResolvedApp = {
          softwareName: this.data.softwareName,
          uuid: this.data.uuid,
          machineName: this.data.vendor
        };
        this.data.cpeName = result.cpeName;
        this.data.resolved = true;
        this.isResolved = true;
        this.refreshData();
      }
    });
  }

  refreshData(): void {
    this.http.get(ApiEndPoints.unique_url).subscribe({
      next: () => {
        this.dialogRef.close();
      },
      error: (error) => {
      }
    });
  }

  onClose(): void {
    if (this.isResolved && !this.data.resolved) {
      this.refreshData();
    }
    this.dialogRef.close();
  }

  navigateToResolveApplications(): void {
     this.applicationResolveService.setResolveData({
      uuid: this.data.uuid,
      softwareName: this.data.softwareName,
      softwareVersion: this.data.softwareVersion,
      vendorName: this.data.vendor
    });
    this.dialogRef.close(); // Close the dialog
    this.router.navigate(['/resolve-applications']); // Navigate to resolve-applications
  }

  public showVulnerabilityMetrics(cveId: String, index: number) {
     this.vulnerabilityService.setSelectedVulnerabilityIndex(index);
    //  this.applicationResolveService.setPreviousUrl("");
     this.applicationResolveService.setPreviousUrl(this.router.url);
     sessionStorage.setItem('previousUrl', '');
     this.dialogRef.close();
     this.router.navigate([`${AppRoutes.vulnerability_metrics}/cve/${cveId}`], { queryParams:{selectedApp : this.data.uuid}});
  }
}