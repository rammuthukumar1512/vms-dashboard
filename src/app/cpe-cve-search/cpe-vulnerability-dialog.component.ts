import { CommonModule } from "@angular/common";
import { MAT_DIALOG_DATA, MatDialogModule, MatDialogRef } from "@angular/material/dialog";
import { MatButtonModule } from "@angular/material/button";
import { MatTableModule } from "@angular/material/table";
import { Component, Inject } from "@angular/core";
import { ToastService } from "../core/services/toast.service";
import { CveResult } from "../models/computer.model";
import { MatTooltip } from "@angular/material/tooltip";
import { AppRoutes } from "../../environments/approutes";
import { Router } from '@angular/router';
import { VulnerabilityService } from '../core/services/vulnerabilityService'; // Add this import

@Component({
  selector: 'app-cpe-vulnerability-dialog',
  templateUrl: './cpe-vulnerability-dialog.component.html',
  styleUrls: ['./cpe-vulnerability-dialog.component.css'],
  standalone: true,
  imports: [CommonModule, MatDialogModule, MatButtonModule, MatTableModule, MatTooltip]
})
export class CpeVulnerabilityDialogComponent {
  displayedColumns: string[] = ['cveId', 'description', 'severity', 'cvssScore'];
  originalVulnerabilities: CveResult[] = [];
  sortState: number = 0;
  selectedCveId: string | null = null;

  constructor(
    public dialogRef: MatDialogRef<CpeVulnerabilityDialogComponent>,
    private router: Router,
    private toastService: ToastService,
    private vulnerabilityService: VulnerabilityService, // Inject VulnerabilityService
    @Inject(MAT_DIALOG_DATA) public data: { cpeName: string; vulnerabilities: CveResult[] }
  ) {}

ngAfterViewInit(): void {
    if (this.selectedCveId) {
      setTimeout(() => {
        const highlightedRow = document.querySelector(`tr.highlight`);
        if (highlightedRow) {
          highlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 0);
    }
  }

  toggleSort() {
    this.sortState = (this.sortState + 1) % 3;
    this.sortVulnerabilities();
  }

  // public showVulnerabilityMetrics(cveId: string) {
  //   const state = {
  //     searchType: 'cpe',
  //     searchVariant: this.vulnerabilityService.getCveCpeSearchState()?.searchVariant || 'CPE Name',
  //     searchQuery: this.vulnerabilityService.getCveCpeSearchState()?.searchQuery || '',
  //     cveIdPart: '',
  //     cpePart: this.vulnerabilityService.getCveCpeSearchState()?.cpePart || 'a',
  //     cpeVendor: this.vulnerabilityService.getCveCpeSearchState()?.cpeVendor || '',
  //     cpeProduct: this.vulnerabilityService.getCveCpeSearchState()?.cpeProduct || '',
  //     cpeVersion: this.vulnerabilityService.getCveCpeSearchState()?.cpeVersion || '',
  //     isEditingCpe: true,
  //     constructedCpe: this.vulnerabilityService.getCveCpeSearchState()?.constructedCpe || '',
  //     searchPerformed: true,
  //     pageIndex: this.vulnerabilityService.getCveCpeSearchState()?.pageIndex || 0,
  //     pageSize: this.vulnerabilityService.getCveCpeSearchState()?.pageSize || 5,
  //     recordIndex: this.vulnerabilityService.getCveCpeSearchState()?.recordIndex || 1,
  //     sortState: this.vulnerabilityService.getCveCpeSearchState()?.sortState || 0,
  //     selectedCveId: null,
  //     selectedCpeName: this.data.cpeName,
  //     fromDialog: true,
  //     cveResults: [],
  //     cpeResults: this.vulnerabilityService.getLastShowedCpeResult() || [], // Use VulnerabilityService instead of state
  //     selectedCpe: { cpe23Uri: this.data.cpeName },
  //     vulnerabilities: this.data.vulnerabilities,
  //     sortStateInDialog: this.sortState,
  //     selectedCveIdInDialog: cveId
  //   };
  //   this.vulnerabilityService.setCveCpeSearchState(state);
  //   this.dialogRef.close();
  //   this.router.navigate([`${AppRoutes.vulnerability_metrics}/cve/${cveId}`]);
  // }
  public showVulnerabilityMetrics(cveId: string) {
  const currentState = this.vulnerabilityService.getCveCpeSearchState() || {};
  const state = {
    searchType: 'cpe',
    searchVariant: currentState.searchVariant || 'CPE Name',
    searchQuery: currentState.searchQuery || '',
    cveIdPart: '',
    cpePart: currentState.cpePart || 'a',
    cpeVendor: currentState.cpeVendor || '',
    cpeProduct: currentState.cpeProduct || '',
    cpeVersion: currentState.cpeVersion || '',
    isEditingCpe: true,
    constructedCpe: currentState.constructedCpe || '',
    searchPerformed: true,
    pageIndex: currentState.pageIndex || 0,
    pageSize: currentState.pageSize || 5,
    recordIndex: currentState.recordIndex || 1,
    sortState: currentState.sortState || 0,
    selectedCveId: null,
    selectedCpeName: this.data.cpeName,
    fromDialog: true,
    cveResults: [],
    cpeResults: this.vulnerabilityService.getLastShowedCpeResult() || [],
    selectedCpe: { cpe23Uri: this.data.cpeName },
    vulnerabilities: this.data.vulnerabilities,
    sortStateInDialog: this.sortState,
    selectedCveIdInDialog: cveId
  };
  this.vulnerabilityService.setCveCpeSearchState(state);
  this.dialogRef.close();
  this.router.navigate([`${AppRoutes.vulnerability_metrics}/cve/${cveId}`]);
}

  ngOnInit() {
    this.originalVulnerabilities = [...this.data.vulnerabilities];
    const state = this.vulnerabilityService.getCveCpeSearchState();
    if (state && state.fromDialog) {
      this.sortState = state.sortStateInDialog;
      this.selectedCveId = state.selectedCveIdInDialog;
      this.sortVulnerabilities();
    }
  }

  private sortVulnerabilities() {
    if (this.sortState === 0) {
      this.data.vulnerabilities = [...this.originalVulnerabilities];
    } else if (this.sortState === 1) {
      this.data.vulnerabilities = [...this.data.vulnerabilities].sort(
        (a, b) => (a.cvssMetrics[0]?.baseScore || 0) - (b.cvssMetrics[0]?.baseScore || 0)
      );
    } else {
      this.data.vulnerabilities = [...this.data.vulnerabilities].sort(
        (a, b) => (b.cvssMetrics[0]?.baseScore || 0) - (a.cvssMetrics[0]?.baseScore || 0)
      );
    }
  }
}
