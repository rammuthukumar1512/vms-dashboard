<div class="container-fluid bg-white p-4">
  <h2 class="text-black-shade fs-5 fnw-bold mb-3">CPE and CVE Search</h2>
  <div class="border border-1 bg-light rounded-3 p-3">
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
      <mat-form-field class="search-field">
        <mat-label>Search Type</mat-label>
        <mat-select [(ngModel)]="searchType" (ngModelChange)="onSearchTypeChange()">
          <mat-option value="cve">CVE Search</mat-option>
          <mat-option value="cpe">CPE Search</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="search-field">
        <mat-label>Search Variant</mat-label>
        <mat-select [(ngModel)]="searchVariant" (ngModelChange)="onSearchVariantChange()">
          <mat-option *ngFor="let variant of getSearchVariants()" [value]="variant">{{ variant }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="search-field flex-grow-1">
        <mat-label>{{ placeholder }}</mat-label>
        <input matInput [(ngModel)]="searchQuery" (keyup.enter)="search()">
        <button mat-icon-button matSuffix (click)="search()">
          <mat-icon>search</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <!-- CVE Results -->
    <div *ngIf="searchType === 'cve'">
      <table mat-table [dataSource]="pagedCveResults" class="comp-table w-100">
        <ng-container matColumnDef="cveId">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>CVE ID</th>
          <td mat-cell *matCellDef="let cve">{{ cve.cveId }}</td>
        </ng-container>
        <ng-container matColumnDef="description">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let cve">{{ cve.cveDescription }}</td>
        </ng-container>
        <ng-container matColumnDef="cvssVersion">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>CVSS Version</th>
          <td mat-cell *matCellDef="let cve">{{ cve.cvssMetrics[0]?.version || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="severity">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>Severity</th>
          <td mat-cell *matCellDef="let cve">{{ cve.cvssMetrics[0]?.baseSeverity || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="cvssScore">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>CVSS Score</th>
          <td mat-cell *matCellDef="let cve">{{ cve.cvssMetrics[0]?.baseScore ?? 'N/A' }}</td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="cveDisplayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: cveDisplayedColumns;" class="cursor-arrow"></tr>
      </table>
      <div *ngIf="!pagedCveResults.length" class="text-center p-2">No CVEs found</div>
    </div>

    <!-- CPE Results -->
    <div *ngIf="searchType === 'cpe'">
      <table mat-table [dataSource]="pagedCpeResults" class="comp-table w-100">
        <ng-container matColumnDef="cpeName">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>CPE Name</th>
          <td mat-cell *matCellDef="let cpe" (click)="openCpeVulnerabilities(cpe)" class="cursor-pointer">{{ cpe.cpe23Uri }}</td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="cpeDisplayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: cpeDisplayedColumns;" class="cursor-pointer"></tr>
      </table>
      <div *ngIf="!pagedCpeResults.length" class="text-center p-2">No CPEs found</div>
    </div>

    <!-- Pagination -->
    <div *ngIf="(searchType === 'cve' && pagedCveResults.length > 0) || (searchType === 'cpe' && pagedCpeResults.length > 0)" class="d-flex justify-content-center mt-2">
      <div class="col-4 d-flex justify-content-evenly align-items-center height-fit-content">
        <mat-select class="border rounded page-size-width p-2"
                    [(ngModel)]="recordIndex"
                    (ngModelChange)="getPage($event, searchType)">
          <mat-option *ngFor="let record of searchType === 'cve' ? cveTotalRecords : cpeTotalRecords" [value]="record">
            {{ record }}
          </mat-option>
        </mat-select>
        <mat-select class="border rounded page-size-width p-2"
                    [(ngModel)]="pageSize"
                    (ngModelChange)="onPageSizeChange($event, searchType)">
          <mat-option *ngFor="let size of pageSizes" [value]="size">{{ size }}</mat-option>
        </mat-select>
        <button (click)="previousPage(searchType)"
                [disabled]="pageIndex === 0"
                class="page-custom-btn btn d-flex justify-content-center align-items-center outline-0 border-0 p-2">
          <mat-icon class="material-symbols-outlined fs-5">arrow_back_ios</mat-icon>
        </button>
        <button (click)="nextPage(searchType)"
                [disabled]="pageIndex >= (searchType === 'cve' ? cveTotalPages : cpeTotalPages) - 1"
                class="page-custom-btn btn d-flex justify-content-center align-items-center outline-0 border-0 p-2">
          <mat-icon class="material-symbols-outlined fs-5">arrow_forward_ios</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>
