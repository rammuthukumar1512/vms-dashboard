<div class="container-fluid bg-white">
      <h2 class="text-black-shade fs-5 fnw-bold p-1 mb-0">Vulnerability Search</h2>
  <div class="sticky-header bg-light p-1 shadow-sm" (scroll)="onScroll($event)">
    <div class="search-controls d-flex align-items-center gap-2 flex-wrap">
      <mat-form-field class="search-field">
        <mat-label>Search Type</mat-label>
        <mat-select [(ngModel)]="searchType" (ngModelChange)="onSearchTypeChange()">
          <mat-option value="cve">CVE Search</mat-option>
          <mat-option value="cpe">CPE Search</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="search-field-variant">
        <mat-label>Search Variant</mat-label>
        <mat-select [(ngModel)]="searchVariant" (ngModelChange)="onSearchVariantChange()">
          <mat-option *ngFor="let variant of getSearchVariants()" [value]="variant">{{ variant }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- CHANGED: Replaced single mat-form-field with this div for conditional parted UI -->
      <div class="d-flex align-items-center gap-2 flex-grow-2">
        <ng-container *ngIf="!isPartedVariant(); else partedSearch">
          <mat-form-field class="flex-grow-1 search-field-search">
            <mat-label>{{ placeholder }}</mat-label>
            <input matInput [(ngModel)]="searchQuery" (keyup.enter)="search()">
          </mat-form-field>
        </ng-container>
        <ng-template #partedSearch>
          <!-- For CVE-ID variant -->
          <div *ngIf="searchVariant === 'CVE-ID'" class="d-flex align-items-center gap-2 flex-grow-1">
            <span class="fixed-text">CVE-</span>
            <mat-form-field class="flex-grow-1">
              <mat-label>Enter YYYY-NNNN</mat-label>
              <input matInput [(ngModel)]="cveIdPart" pattern="^\d{4}-\d{4}$" maxlength="9" (keyup.enter)="search()">
            </mat-form-field>
          </div>
          <!-- For CPE Name variant -->
          <div *ngIf="searchVariant === 'CPE Name'" class="d-flex align-items-center gap-2 flex-grow-1 flex-wrap">
             <ng-container *ngIf="isEditingCpe; else displayCpe">

            <!-- <span class="fixed-text ms-2">cpe:2.3:</span> -->
            <mat-form-field class="search-field-part">
              <mat-label>Part</mat-label>
              <mat-select [(ngModel)]="cpePart">
                <mat-option value="a">a</mat-option>
                <mat-option value="h">h</mat-option>
                <mat-option value="o">o</mat-option>
              </mat-select>
            </mat-form-field>
            <ng-container *ngIf="cpePart">
              <!-- <span>:</span> -->
              <mat-form-field class="search-field-input">
                <mat-label>Enter Vendor</mat-label>
                <input matInput [(ngModel)]="cpeVendor" pattern="^(?!\*)[^:\s]+$" (keyup.enter)="search()">
              </mat-form-field>
              <!-- <span>:</span> -->
              <mat-form-field class="search-field-input">
                <mat-label>Enter Product</mat-label>
                <input matInput [(ngModel)]="cpeProduct" pattern="^(?!\*)[^:\s]+$" (keyup.enter)="search()">
              </mat-form-field>
              <!-- <span>:</span> -->
              <mat-form-field class="search-field-input">
                <mat-label>Enter Version</mat-label>
                <input matInput [(ngModel)]="cpeVersion" pattern="^(?!\*)[^:\s]+$" (keyup.enter)="search()">
              </mat-form-field>
              <!-- <span>:*:*:*:*:*:*:*</span> -->
            </ng-container>
             </ng-container>
               <ng-template #displayCpe>
              <span class="display-text" matTooltip="{{constructedCpe}}">{{ constructedCpe }}</span>
              <button mat-icon-button (click)="editCpe()">
                <mat-icon matTooltip="Edit CPE">edit</mat-icon>
              </button>
            </ng-template>
          </div>
        <!-- <div *ngIf="searchVariant === 'Likely CPE Name'" class="d-flex align-items-center gap-2 flex-grow-1 flex-wrap">
            <span class="fixed-text ms-2">cpe:2.3:</span>
      </div> -->
      <!-- <div *ngIf="searchVariant === 'Likely CPE Name'" class="d-flex align-items-center gap-2 flex-grow-1 flex-wrap">
  <span class="fixed-text ms-2">cpe:2.3:</span>
  <mat-form-field class="flex-grow-1 search-field-search">
    <mat-label>Enter Likely CPE</mat-label>
    <input matInput [(ngModel)]="searchQuery" placeholder="e.g., a:microsoft:edge:138.0.3351.77:*:*:*:*:*:*:*" (keyup.enter)="search()">
  </mat-form-field>
</div> -->

        </ng-template>
        <button mat-icon-button (click)="search()">
          <mat-icon matTooltip="Search">search</mat-icon>
        </button>
      </div>
      <!-- END OF CHANGES -->
    </div>
  </div>

  <div class="results-container border bg-light rounded-3 p-0 overflow-auto" (scroll)="onScroll($event)">
    <!-- CVE Table -->
    <div *ngIf="searchType === 'cve' && searchPerformed && (cveResults.length > 0 || searchQuery)">
      <table mat-table [dataSource]="pagedCveResults" class="comp-table w-100">
        <ng-container matColumnDef="cveId">
          <th  class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>CVE ID</th>
          <td mat-cell *matCellDef="let cve">{{ cve.cveId }}</td>
        </ng-container>

        <ng-container matColumnDef="description" class="px-4">
          <th  class="text-secondary fw-bolder description-column" mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let cve" class="description-column">{{ cve.cveDescription }}</td>
        </ng-container>

        <ng-container matColumnDef="cvssVersion">
          <th  class="text-secondary fw-bolder text-center" mat-header-cell *matHeaderCellDef>CVSS Version</th>
          <td class="text-center" mat-cell *matCellDef="let cve">{{ cve.cvssMetrics[0]?.version || 'N/A' }}</td>
        </ng-container>

        <ng-container matColumnDef="severity">
          <th  class="text-secondary fw-bolder px-4" mat-header-cell *matHeaderCellDef>Severity</th>
          <td class="px-4" mat-cell *matCellDef="let cve">
            <span [ngClass]="{
              'severity-critical': cve.cvssMetrics[0]?.baseSeverity?.toLowerCase() === 'critical',
              'severity-high': cve.cvssMetrics[0]?.baseSeverity?.toLowerCase() === 'high',
              'severity-medium': cve.cvssMetrics[0]?.baseSeverity?.toLowerCase() === 'medium',
              'severity-low': cve.cvssMetrics[0]?.baseSeverity?.toLowerCase() === 'low'
            }">
              {{ cve.cvssMetrics[0]?.baseSeverity || 'N/A' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="cvssScore">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>
            CVSS Score
            <span class="cvss-sort-icon" (click)="toggleCvssSort()" *ngIf="searchType === 'cve' && searchPerformed && pagedCveResults.length > 0">
              <i *ngIf="sortState === 0" class="bi bi-filter text-secondary-emphasis"></i>
              <i *ngIf="sortState === 1" class="bi bi-sort-numeric-up-alt text-secondary-emphasis"></i>
              <i *ngIf="sortState === 2" class="bi bi-sort-numeric-down-alt text-secondary-emphasis"></i>
            </span>
          </th>
          <td class="px-4" mat-cell *matCellDef="let cve">{{ cve.cvssMetrics[0]?.baseScore ?? 'N/A' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="cveDisplayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: cveDisplayedColumns;" class="cursor-arrow"></tr>
      </table>
      <div *ngIf="searchType === 'cve' && searchPerformed && cveResults.length === 0 && searchQuery" class="text-center py-4">No CVEs found</div>
    </div>

    <!-- CPE Table -->
    <div *ngIf="searchType === 'cpe' && searchPerformed && (cpeResults.length > 0 || searchQuery)">
      <table mat-table [dataSource]="pagedCpeResults" class="comp-table w-100">
        <ng-container matColumnDef="cpeName">
          <th class="text-secondary fw-bolder" mat-header-cell *matHeaderCellDef>CPE Name</th>
          <td mat-cell *matCellDef="let cpe" (click)="openCpeVulnerabilities(cpe)" class="cursor-pointer">
            {{ cpe.cpe23Uri }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="cpeDisplayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: cpeDisplayedColumns;" class="cursor-pointer"></tr>
      </table>
      <div *ngIf="!pagedCpeResults.length" class="text-center py-4">No CPEs found</div>
    </div>

    <!-- Pagination -->
    <div *ngIf="((searchType === 'cve' && searchPerformed && pagedCveResults.length > 0) || (searchType === 'cpe' && searchPerformed && pagedCpeResults.length > 0))" class="d-flex justify-content-center m-2">
      <div class="col-4 d-flex justify-content-evenly align-items-center height-fit-content">
        <mat-select class="border rounded page-size-width p-2" [(ngModel)]="recordIndex" (ngModelChange)="getPage($event, searchType)">
          <mat-option *ngFor="let record of searchType === 'cve' ? cveTotalRecords : cpeTotalRecords" [value]="record">
            {{ record }}
          </mat-option>
        </mat-select>
        <mat-select class="border rounded page-size-width p-2" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event, searchType)">
          <mat-option *ngFor="let size of pageSizes" [value]="size">{{ size }}</mat-option>
        </mat-select>
        <button (click)="previousPage(searchType)" [disabled]="pageIndex === 0" class="page-custom-btn btn  d-flex justify-content-center align-items-center outline-0 border-0 p-2">
          <mat-icon class="material-symbols-outlined fs-5">arrow_back_ios</mat-icon>
        </button>
        <button (click)="nextPage(searchType)" [disabled]="pageIndex >= (searchType === 'cve' ? cveTotalPages : cpeTotalPages) - 1" class="page-custom-btn btn  d-flex justify-content-center align-items-center outline-0 border-0 p-2">
          <mat-icon class="material-symbols-outlined fs-5">arrow_forward_ios</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>